// Generated by CoffeeScript 1.3.1
(function() {

  define(function(require, exports, module) {
    var FileBrowser, FileItem, FileItemList, FileItemView, ITEM_HEIGHT, addKeyboardListener, node;
    require('vendor/link!css/filebrowser.css');
    node = require('lib/utils').node;
    addKeyboardListener = require('lib/keyboard').addKeyboardListener;
    ITEM_HEIGHT = 70;
    FileItem = Backbone.Model.extend({
      defaults: function() {
        return {
          type: 'file',
          file: null,
          items: null,
          parent: null
        };
      },
      getName: function() {
        return (this._pfx != null ? this._pfx + '/' : '') + this.get('path');
      },
      getDepth: function() {
        var parent;
        parent = this.get('parent');
        if (parent) {
          return parent.getDepth() + (this.empty ? 0 : 1);
        } else {
          return -1;
        }
      }
    });
    FileItemList = Backbone.Collection.extend({
      model: FileItem,
      comparator: function(p) {
        return p.get('type');
      }
    });
    FileItemView = Backbone.View.extend({
      className: 'file-item',
      events: {
        'dblclick': 'openFile',
        'click .name': 'openFile',
        'click': 'onClick'
      },
      initialize: function() {
        var items, parsedName;
        this.model.view = this.el.view = this;
        this.model.on('destroy', this.remove, this);
        this.model.on('change', this.render, this);
        if (this.model.get('type') === 'file') {
          parsedName = this.model.get('file').get('name').match(/^(.+)(\.[^\.]+)$/);
          this.$el.addClass('is-file');
          this.$el.append([
            node('div', {
              "class": 'lastmod'
            }, '30min ago'), node('div', {
              "class": 'size'
            }, '10KB'), node('div', {
              "class": 'name'
            }, parsedName[1], node('span', {
              "class": 'ext'
            }, parsedName[2]))
          ]);
        } else {
          this.$el.addClass('is-dir');
          this.$el.append([
            node('div', {
              "class": 'expand-bullet'
            }), node('div', {
              "class": 'name'
            }, this.model.get('path')), this.itemsEl = node('div', {
              "class": 'items'
            })
          ]);
          items = this.model.get('items');
          items.on('add', this.onItemAdd, this);
          items.on('reset', this.onItemAddAll, this);
        }
        return app.console.on('change:client', this.render, this);
      },
      onItemAdd: function(item) {
        var index, previous, previousView, view,
          _this = this;
        view = (new FileItemView({
          model: item,
          parent: this.model
        })).render();
        view.on('select', function(item) {
          return _this.trigger('select', item);
        });
        index = this.model.get('items').indexOf(view.model);
        previous = this.model.get('items').at(index - 1);
        previousView = previous && previous.view;
        if (index === 0 || !previous || !previousView) {
          $(this.itemsEl).prepend(view.el);
        } else {
          $(previousView.el).after(view.el);
        }
        return this.render();
      },
      onItemAddAll: function(items) {
        $(this.itemsEl).empty();
        return this.model.get('items').each(this.onItemAdd, this);
      },
      openFile: function() {
        var _ref;
        return app.console.openFile((_ref = this.model.get('file')) != null ? _ref.get('url') : void 0);
      },
      onClick: function(e) {
        this.select();
        e.stopPropagation();
        return e.preventDefault();
      },
      destroy: function() {
        this.model.off('destroy', this.remove, this);
        this.model.off('change', this.render, this);
        return app.console.off('change:client', this.render, this);
      },
      select: function(bool) {
        if (bool == null) {
          bool = true;
        }
        this.$el.toggleClass('is-selected', bool);
        if (bool) {
          this.trigger('select', this.model);
        }
        return this.selected = bool;
      },
      render: function() {
        var depth, items;
        items = this.model.get('items');
        depth = this.model.getDepth();
        if (depth !== this.lastDepth) {
          this.$el.css({
            paddingLeft: depth * 20
          });
          this.lastDepth = depth;
        }
        if (!items) {
          return this;
        }
        if (this.model.get('type') === 'dir' && items.size() === 1 && items.at(0).get('type') === 'dir') {
          this.model.empty = items.at(0);
          this.model.empty._pfx = this.model.getName();
          this.model.empty.view.render();
          this.$el.addClass('is-empty');
        } else if (this.model.empty) {
          this.model.empty._pfx = null;
          this.model.empty.view.render();
          this.model.empty = null;
          this.$el.removeClass('is-empty');
        }
        $(this.$('.name')[0]).text(this.model.getName());
        /*
              json = @model.toJSON()
              clientId = app.console?.client?.id
              parsedName = json.name.match /^(.+)(\.[^\.]+)$/
              _.extend json,
                isActive: clientId && (json.clients.indexOf clientId) != -1
                isOpen: !!json.edit
                name: parsedName[1]
                extension: parsedName[2]
                isHelper: 0 == json.url.indexOf '#local'
              @$el.html @template json
        */

        return this;
      }
    });
    FileBrowser = Backbone.View.extend({
      initialize: function() {
        var rootView,
          _this = this;
        _.bindAll(this, 'onSelect', 'onKeyDown');
        this.subviews = [];
        this.collection.on('add', this.onAddFile, this);
        this.collection.on('reset', this.onAddAllFiles, this);
        addKeyboardListener('filebrowser', this.el);
        this.el.listenKey('file-prev', {
          mac: 'down',
          exec: function() {
            return _this.moveSelection(1);
          }
        });
        this.el.listenKey('file-next', {
          mac: 'up',
          exec: function() {
            return _this.moveSelection(-1);
          }
        });
        this.el.listenKey('file-first', {
          mac: 'home',
          exec: function() {
            return _this.collection.first().view.select();
          }
        });
        this.el.listenKey('file-last', {
          mac: 'end',
          exec: function() {
            return _this.collection.last().view.select();
          }
        });
        this.el.listenKey('select-file', {
          mac: 'return',
          exec: function() {
            var _ref, _ref1;
            return (_ref = _this.selectedFile) != null ? (_ref1 = _ref.view) != null ? _ref1.openFile() : void 0 : void 0;
          }
        });
        this.root = new FileItem({
          type: 'dir',
          path: '',
          items: new FileItemList
        });
        rootView = new FileItemView({
          model: this.root
        });
        rootView.on('select', this.onSelect);
        this.$el.append(rootView.render().el);
        this.$el.on('keydown', this.onKeyDown);
        return this.search = '';
      },
      destroy: function() {
        this.collection.each(function(file) {
          return file.view.destroy();
        });
        this.collection.off('add', this.addOne, this);
        return this.collection.off('reset', this.addAll, this);
      },
      onKeyDown: function(e) {
        var char, curTime, file, filter, search, _ref;
        char = String.fromCharCode(e.keyCode);
        if (!(char.length && /[\w-\.]/.test(char))) {
          return this.search = '';
        }
        curTime = new Date();
        if (curTime - this.lastCharTime > 700) {
          this.search = '';
        }
        this.search += char.toLowerCase();
        this.lastCharTime = curTime;
        search = this.search;
        file = null;
        filter = function(item) {
          if (file) {
            return;
          }
          if (item.get('type') === 'dir') {
            return item.get('items').each(function(i) {
              return filter(i);
            });
          } else if (-1 !== item.get('file').get('name').toLowerCase().indexOf(search)) {
            return file = item;
          }
        };
        filter(this.root);
        return file != null ? (_ref = file.view) != null ? _ref.select() : void 0 : void 0;
      },
      moveSelection: function(delta) {
        var index, items, selectedFile;
        selectedFile = this.selectedFile;
        items = this.$('.file-item');
        items = _.filter(items, function(item) {
          return !$(item).hasClass('is-empty');
        });
        index = items.indexOf((selectedFile != null ? selectedFile.view.el : void 0) || items[0]);
        index += delta;
        if (index < 1) {
          index = 1;
        }
        if (index >= items.length) {
          index = items.length - 1;
        }
        items[index].view.select();
        return event.preventDefault();
      },
      getParent: function(item, path) {
        var found, items, newitem,
          _this = this;
        if (!path.length || path.length === 1 && path[0] === item.get('path')) {
          return item;
        }
        items = item.get('items');
        found = false;
        items.each(function(subitem) {
          if (subitem.get('type') === 'dir' && subitem.get('path') === path[0]) {
            return found = _this.getParent(subitem, path.slice(1));
          }
        });
        if (found) {
          return found;
        }
        newitem = new FileItem({
          parent: item,
          path: path[0],
          type: 'dir',
          items: new FileItemList
        });
        items.add(newitem);
        return this.getParent(newitem, path.slice(1));
      },
      onAddFile: function(file) {
        var fileitem, parent, path;
        path = file.get('url').replace(/\/[^\/]*$/, '');
        if (/^#local/.test(file.get('url'))) {
          path = 'locals';
        }
        parent = this.getParent(this.root, path.split('/'));
        fileitem = new FileItem({
          type: 'file',
          file: file,
          parent: parent
        });
        return parent.get('items').add(fileitem);
      },
      onAddAllFiles: function() {
        return this.collection.each(this.onAddFile, this);
      },
      onSelect: function(file) {
        var selectedFile, _base;
        selectedFile = this.selectedFile;
        this.selectedFile = file;
        if (!selectedFile || selectedFile === file) {
          return;
        }
        selectedFile.view.select(false);
        return typeof (_base = file.view.el).scrollIntoViewIfNeeded === "function" ? _base.scrollIntoViewIfNeeded() : void 0;
      }
    });
    return module.exports = FileBrowser;
  });

}).call(this);
